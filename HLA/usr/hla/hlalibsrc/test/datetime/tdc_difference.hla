program difference_test;
#include( "stdlib.hhf" )
#include( "dtClass.hhf" )

static
	baseDate	:date.daterec;
	incDate		:date.daterec;
	FiveYears	:date.daterec;
	endDate		:date.daterec;
	
	days		:dword;
	days5		:dword;
	
	dc			:dateClass;
	vdc			:virtualDateClass;
	base		:dateClass;
	vbase		:virtualDateClass;

		
	
begin difference_test;

	 
	date.setFormat( date.mmddyyyy );
	dc.create();
	vdc.create();
	base.create();
	vbase.create();
	
	date.pack( 1, 1, date.minYear, incDate );
	mov( incDate, eax );
	mov( eax, baseDate );
	
	date.pack( 12, 31, date.maxYear-1, endDate );
	
	mov( 0, days );
	while( mov( endDate, eax ) >= (type dword incDate) ) do
	
		// Test the number of days up to the current date:
		
		mov( baseDate, eax );
		mov( eax, base.theDate );
		mov( eax, vbase.theDate );
		dc.difference( base );
		mov( eax, ebx );
		vdc.difference( vbase );
		mov( eax, ecx );
		date.daysBetween( baseDate, incDate );		
		if
		( 
				eax <> days
			||	eax <> ebx
			||	eax <> ecx 
		) then
		
			stderr.put
			( 
				nl nl 
				"***************************************************" nl
				"dateClass.difference failed!", nl,
				"daysBetween =  ", (type uns32 eax ), nl,
				"dc.Between  =  ", (type uns32 ebx ), nl,
				"vdc.Between =  ", (type uns32 ecx ), nl,
				"days        =  ", (type uns32 days ), nl,
				"date =    '"
			);
			date.a_toString( incDate );
			stderr.put
			(
				(type string eax), "'" nl
				"***************************************************" nl
				nl 
			);
			stdout.put( "Press Enter to Continue: " );
			stdin.readLn();
			os.exitProcess(1);
			
		endif;
		
		// Let's test a set of dates up to five years before the test date.
		
		mov( incDate.year, ax );
		if( ax >= date.minYear+6 ) then
		
			mov( incDate, eax );
			mov( eax, FiveYears );
			date.subDays( 4*400, FiveYears );
			for( mov( 4*400, ebx ); ebx > 0; sub( 200, ebx )) do
			
				dc.daysBetween( FiveYears );
				mov( eax, edx );
				vdc.daysBetween( FiveYears );
				mov( eax, ecx );
				date.daysBetween( FiveYears, incDate );
				if
				( 
						eax <> ebx
					||	eax <> ecx 
					||	eax <> edx 
				) then
				
					stderr.put
					( 
						nl nl 
						"***************************************************" nl
						"dateClass.difference(2) failed!", nl,
						"daysBetween =  ", (type uns32 eax ), nl,
						"dc.Between  =  ", (type uns32 edx ), nl,
						"vdc.Between =  ", (type uns32 ecx ), nl,
						"days        =  ", (type uns32 ebx ), nl,
						"date =    '"
					);
					date.a_toString( incDate );
					stderr.put
					(
						(type string eax), "'" nl
						"***************************************************" nl
						nl 
					);
					stdout.put( "Press Enter to Continue: " );
					stdin.readLn();
					os.exitProcess(1);
				
				endif;
				date.addDays( 200, FiveYears );
				
			endfor;
			
		endif;
		inc( days );
		date.addDays( 1, incDate );
		dc.addDays( 1 );
		vdc.addDays( 1 );
		
	endwhile;
	stderr.put( "dateClass.difference succeeded!" nl );
	os.exitProcess(0);
		
end difference_test;

													