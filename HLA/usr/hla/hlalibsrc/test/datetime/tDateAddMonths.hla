program DatePlusMonths_test;
#include( "stdlib.hhf" )

static
	baseDate	:date.daterec;
	incDate		:date.daterec;
	addDate		:date.daterec;
	ovflDate	:date.daterec;
	
	altDate		:date.daterec;
	endDate		:date.daterec;
	
	months		:dword;
	
	overflow	:dword[13] :=
				[
					0, 0, 3, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0
				];
	
begin DatePlusMonths_test;

	 
	date.setFormat( date.mmddyyyy );
	
	date.pack( 12, 1, date.minYear, baseDate );
	mov( (type dword baseDate), eax );
	mov( eax, (type dword incDate));
	mov( eax, (type dword addDate));
	mov( eax, (type dword altDate));
	
	date.pack( 12, 1, date.maxYear-1, endDate );
	
	
	mov( 0, months );
	while( mov( endDate, eax ) >= (type dword altDate) ) do
	
		inc( months );
		mov( (type dword baseDate), eax );
		mov( eax, addDate );
		
		xor( ecx, ecx );
		date.addMonths( months, addDate );
		test( eax, eax );
		jnz badOverflow;
		 
		date.addMonths( 1, incDate );
		test( eax, eax );
		jnz badOverflow;
		
		inc( altDate.month );
		if( altDate.month > 12 ) then
			
			mov( 1, altDate.month );
			inc( altDate.year );
			
		endif;
		
		// Compute the number of extra days between months
		// when adding one month to ovflDate.
		
		mov( incDate, eax );
		mov( eax, altDate );
		movzx( ah, edx );
		mov( date.DaysInMonth[edx*4], ecx ); 
		if( date.isLeapYear( altDate.year ) && dl = 2 ) then
		
			inc( cl );
			
		endif;
		date.pack( dl, cl, altDate.year, ovflDate );
		if( edx < 12 ) then
		
			mov( date.DaysInMonth[edx*4 + 4], esi );
			if( date.isLeapYear( altDate.year ) && edx = 1 ) then
			
				inc( esi );
				
			endif;
			sub( esi, ecx );
			if( @s ) then
			
				xor( ecx, ecx );
				
			endif;
		
		else
		
			xor( ecx, ecx ); // Dec->Jan = 0;
			
		endif;
		date.addMonths( 1, ovflDate );
		cmp( eax, ecx );
		jne badOverflow;
		
		mov( addDate, eax );
		mov( incDate, ebx );
		mov( altDate, ecx );
		cmp( eax, ebx );
		jne badDate;
		cmp( eax, ecx );
		jne badDate;
		
	endwhile;
	stderr.put( "date.addMonths succeeded!" nl );
	os.exitProcess(0);
		
		
badDate:
	stderr.put
	( 
		nl nl 
		"***************************************************" nl
		"date.addMonths failed!", nl,
		"incDate= '"
	);
	date.a_toString( incDate );
	stderr.put
	(
		(type string eax), "'" nl
		"addDate=  '"
	);
	str.free( eax );
	date.a_toString( addDate );
	stderr.put
	(
		(type string eax), "'" nl
	);
	str.free( eax );
	date.a_toString( altDate );
	stderr.put
	(
		"altDate= '",
		(type string eax), "'" nl
	
		"***************************************************" nl
		nl 
	);
	str.free( eax );
	stdout.put( "Press Enter to Continue: " );
	stdin.readLn();
	os.exitProcess(1);

badOverflow:
	stderr.put
	( 
		nl nl 
		"***************************************************" nl
		"date.addMonths failed!", nl,
		"Overflow should be ", (type uns32 ecx), ", was ", (type uns32 eax), nl
		"incDate= '"
	);
	date.a_toString( incDate );
	stderr.put
	(
		(type string eax), "'" nl
		"addDate=  '"
	);
	str.free( eax );
	date.a_toString( addDate );
	stderr.put
	(
		(type string eax), "'" nl
	);
	str.free( eax );
	date.a_toString( altDate );
	stderr.put
	(
		"altDate= '",
		(type string eax), "'" nl
	);
	date.a_toString( ovflDate );
	stderr.put
	(
		"ovflDate= '",
		(type string eax), "'" nl
	
		"***************************************************" nl
		nl 
	);
	str.free( eax );
	stdout.put( "Press Enter to Continue: " );
	stdin.readLn();
	os.exitProcess(1);

end DatePlusMonths_test;

													