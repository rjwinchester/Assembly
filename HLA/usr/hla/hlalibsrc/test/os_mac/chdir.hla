program chdir_test;
#include( "stdlib.hhf" )
#include( "mac.hhf" )

static
	scwdir		:str.strvar(1024);
	shortdir	:str.strvar(1024);
	snewdir		:str.strvar(1024);
	joinedPaths	:str.strvar(1024);
	renamedPath	:str.strvar(1024);
	
	cwdir		:char[1024];
	newdir		:char[1024];

#macro getcwd( buf );
	mac.getcwd( &buf, 1024 );
	str.cpyz( lea( eax, buf ), @text( "s"+@string(buf)));
#endmacro

begin chdir_test;

	getcwd( cwdir );	
	mac.chdir( "." );
	getcwd( newdir );
	if( str.ne( scwdir, snewdir )) then
	
		stderr.put
		( 
			"chdir_test failed!" nl
			"snewdir = '", snewdir, "'" nl
			"cwdir   = '", scwdir,  "'" nl
			"Should both be the same" nl
		);
		os.exitProcess( 1 );
		
	endif;
	filesys.extractPath( scwdir, shortdir );
	
	mac.chdir( ".." );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", (type uns32 eax), ") switching to directory .." nl 
		);
		os.exitProcess( 1 );
		
	endif;
	
	getcwd( newdir );
	if( str.ne( snewdir, shortdir )) then
	
		stderr.put
		( 
			"chdir_test(2) failed!" nl
			"snewdir   = '", snewdir, "'" nl
			"shortdir  = '", shortdir,  "'" nl
			"Should both be the same" nl
		);
		os.exitProcess( 1 );
		
	endif;
	
	// Try out mkdir and rmdir:
	
	filesys.joinPaths( scwdir, "chdir.dir", joinedPaths );
	filesys.joinPaths( scwdir, "rmdir.dir", renamedPath );
	mac.chdir( scwdir );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", (type uns32 eax), ") switching to directory ", scwdir, nl 
		);
		os.exitProcess( 1 );
		
	endif;
	
	mac.mkdir( "chdir.dir", -1 );
	if( @c ) then
	
		stdout.put( "could not create directory chdir.dir", nl );
		os.exitProcess( 1 );
		
	endif;
	
	mac.chdir( "chdir.dir" );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", (type uns32 eax), ") switching to directory chdir.dir" nl 
		);
		os.exitProcess( 1 );
		
	endif;
	
	getcwd( newdir );
	if( str.ne( snewdir, joinedPaths )) then
	
		stderr.put
		( 
			"chdir_test(3) failed!" nl
			"snewdir   = '", snewdir, "'" nl
			"shortdir  = '", joinedPaths,  "'" nl
			"Should both be the same" nl
		);
		os.exitProcess( 1 );
		
	endif;
	
	mac.chdir( scwdir );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", (type uns32 eax), ") switching to directory ", scwdir, nl 
		);
		os.exitProcess( 1 );
		
	endif;
	
	mac.rename( joinedPaths, renamedPath );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", 
			(type uns32 eax), 
			") renaming directory ", 
			joinedPaths, 
			" to ", 
			renamedPath, 
			nl 
		);
		os.exitProcess( 1 );
		
	endif;
	
	mac.rmdir( renamedPath );
	if( @c ) then
	
		stderr.put
		( 
			"Error (", (type uns32 eax), ") removing directory ", renamedPath, nl 
		);
		os.exitProcess( 1 );
		
	endif;
	if( filesys.exists( renamedPath )) then
		
		stderr.put
		( 
			"Error, failed to remove directory ", renamedPath, nl 
		);
		os.exitProcess( 1 );
		
	endif;
	stdout.put( "chdir test succeeded!" nl );
	
end chdir_test;

													