program gettimeofday_test;
#include( "stdlib.hhf" )
#include( "mac.hhf" )

static
	utime	:qword;
	tmv		:mac.timeval;
	tz		:mac.timezone;
	
	cdate	:date.daterec;
	ctime	:time.timerec;

begin gettimeofday_test;

	mac.gettimeofday( tmv, tz );
	if( @c ) then
	
		stdout.put( "gettimeofday call failed, eax=", (type uns32 eax), nl );
		os.exitProcess( 1 );
		
	endif;
	mov( eax, (type dword utime));
	mov( 0, (type dword utime[4]));
	time.fromUnixTime( utime, ctime, cdate );
	date.a_toString( cdate );
	stdout.put( "Date: ", (type string eax), nl );
	str.free( eax );
	
	time.a_toString( ctime );
	stdout.put( "Time: ", (type string eax), nl );
	str.free( eax );
	
	mov( 123_456_789, ecx );
	repeat
	
		mac.gettimeofday( tmv, tz );
		cmp( eax, (type dword utime));
		breakif( @nz );
		dec( ecx );
		
	until( @z );
	if( ecx = 0 ) then
	
		stdout.put( "gettimeofday value never changes" nl );
		os.exitProcess( 1 );
		
	endif;
	stdout.put( "gettimeofday test succeeded!" nl );
	
end gettimeofday_test;

													